<!-- uit-manager.html - Versión mejorada -->
<div class="uit-manager-container">

  <!-- Header -->
  <div class="header-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>monetization_on</mat-icon>
          Gestión de UITs
        </mat-card-title>
        <mat-card-subtitle>
          Administrar Unidades Impositivas Tributarias por año de vigencia
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-actions>
        <button mat-raised-button
                color="primary"
                (click)="onCrear()"
                [disabled]="loading || !tieneMetadata">
          <mat-icon>add</mat-icon>
          Nueva UIT
        </button>

        <button mat-button
                (click)="cargarMetadataYDatos()"
                [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Tabla de UITs -->
  <div class="tabla-section">
    <mat-card>
      <mat-card-content>

        <!-- Loading -->
        <div *ngIf="loading" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Cargando UITs...</p>
        </div>

        <!-- Tabla -->
        <div *ngIf="!loading && tieneMetadata && tieneDatos" class="tabla-wrapper">
          <table mat-table [dataSource]="dataSource" class="mat-elevation-z4">

            <!-- Columnas dinámicas -->
            <ng-container *ngFor="let col of columnas" [matColumnDef]="col">
              <th mat-header-cell *matHeaderCellDef>
                {{ obtenerDescripcionColumna(col) }}
              </th>
              <td mat-cell *matCellDef="let row">
                {{ formatearValor(row[col], col) }}
              </td>
            </ng-container>

            <!-- Columna de acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let row">
                <button mat-icon-button
                        color="primary"
                        (click)="onEditar(row); $event.stopPropagation()"
                        matTooltip="Editar UIT">
                  <mat-icon>edit</mat-icon>
                </button>

                <button mat-icon-button
                        color="warn"
                        (click)="onEliminar(row); $event.stopPropagation()"
                        matTooltip="Eliminar UIT">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Headers y filas -->
            <tr mat-header-row *matHeaderRowDef="columnasConAcciones"></tr>
            <tr mat-row
                *matRowDef="let row; columns: columnasConAcciones;"
                class="tabla-fila"
                (click)="onEditar(row)">
            </tr>
          </table>
        </div>

        <!-- Sin datos -->
        <div *ngIf="!loading && (!tieneDatos || !tieneMetadata)" class="sin-datos">
          <mat-icon class="empty-icon">inbox</mat-icon>
          <h3>No hay UITs disponibles</h3>
          <p *ngIf="!tieneMetadata">Error al cargar metadata del sistema</p>
          <p *ngIf="tieneMetadata && !tieneDatos">No se encontraron UITs registradas</p>

          <button mat-raised-button
                  color="primary"
                  (click)="onCrear()"
                  *ngIf="tieneMetadata">
            <mat-icon>add</mat-icon>
            Crear Primera UIT
          </button>
        </div>

      </mat-card-content>
    </mat-card>
  </div>

  <!-- Formulario dinámico (cuando esté disponible) -->
  <div *ngIf="mostrandoFormulario" class="formulario-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>{{ modoEdicion ? 'edit' : 'add' }}</mat-icon>
          {{ modoEdicion ? 'Editar UIT' : 'Nueva UIT' }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>

        <!-- Formulario dinámico -->
        <app-formulario-dinamico *ngIf="camposFormulario.length"
                                 [campos]="camposFormulario"
                                 [modoEdicion]="modoEdicion"
                                 [loading]="loading"
                                 [titulo]="modoEdicion ? 'Editar UIT' : 'Nueva UIT'"
                                 [subtitulo]="'Gestión de Unidad Impositiva Tributaria'"
                                 (guardar)="onGuardar($event)"
                                 (cancelar)="cerrarFormulario()">
        </app-formulario-dinamico>

        <!-- Fallback mientras no está el formulario dinámico -->
        <div class="formulario-fallback">
          <p>Formulario dinámico no disponible</p>
          <button mat-button (click)="cerrarFormulario()">
            <mat-icon>close</mat-icon>
            Cerrar
          </button>
        </div>

      </mat-card-content>
    </mat-card>
  </div>

</div>
