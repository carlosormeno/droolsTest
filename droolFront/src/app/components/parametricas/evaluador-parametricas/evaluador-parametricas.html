<p>evaluador-parametricas works!</p>
<div class="evaluador-container">
  <div class="header-section">
    <h1>
      <mat-icon>assessment</mat-icon>
      Evaluador de Paramétricas Temporales
    </h1>
    <p>Evalúa requerimientos usando paramétricas vigentes según la fecha del proceso</p>
  </div>

  <div class="content-tabs">
    <mat-tab-group>
      <!-- Tab de Evaluación -->
      <mat-tab label="Evaluación">
        <div class="tab-content">
          <div class="evaluador-grid">

            <!-- Formulario de Requerimiento -->
            <mat-card class="requerimiento-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>edit_note</mat-icon>
                  Datos del Requerimiento
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <form class="requerimiento-form">

                  <!-- Fecha de Evaluación -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Fecha del Requerimiento</mat-label>
                      <input matInput
                             [matDatepicker]="picker"
                             [(ngModel)]="evaluacion.fechaEvaluacion"
                             name="fechaEvaluacion"
                             (dateChange)="onFechaChange()"
                             [min]="fechaMinima"
                             [max]="fechaMaxima"
                             required>
                      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                      <mat-datepicker #picker></mat-datepicker>
                      <mat-hint>Fecha que determina las paramétricas vigentes</mat-hint>
                    </mat-form-field>
                  </div>

                  <!-- Monto del Contrato -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Monto del Contrato</mat-label>
                      <input matInput
                             [(ngModel)]="evaluacion.montoContrato"
                             name="montoContrato"
                             type="number"
                             min="1"
                             step="0.01"
                             placeholder="25000.00"
                             required>
                      <span matPrefix>S/ &nbsp;</span>
                      <mat-icon matSuffix>monetization_on</mat-icon>
                      <mat-hint *ngIf="tieneParametricasVigentes">
                        {{ calcularMultiploUIT(evaluacion.montoContrato) }}
                      </mat-hint>
                    </mat-form-field>
                  </div>

                  <!-- Año de Vigencia (calculado automáticamente) -->
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Año de Vigencia</mat-label>
                      <mat-select [(ngModel)]="evaluacion.anioVigencia"
                                  name="anioVigencia"
                                  [disabled]="true">
                        <mat-option *ngFor="let anio of aniosDisponibles" [value]="anio">
                          {{ anio }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>calendar_today</mat-icon>
                      <mat-hint>Se calcula automáticamente desde la fecha</mat-hint>
                    </mat-form-field>
                  </div>

                  <!-- Campos Opcionales -->
                  <mat-divider></mat-divider>
                  <h4>Parámetros Opcionales</h4>

                  <div class="form-row-double">
                    <mat-form-field appearance="outline">
                      <mat-label>Tipo de Proceso</mat-label>
                      <mat-select [(ngModel)]="evaluacion.tipoProcesoId" name="tipoProcesoId">
                        <mat-option [value]="undefined">Determinar automáticamente</mat-option>
                        <mat-option *ngFor="let tipo of tiposProceso" [value]="tipo.id">
                          {{ tipo['codigo'] }} - {{ tipo['nombre'] }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>account_tree</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Objeto de Contratación</mat-label>
                      <mat-select [(ngModel)]="evaluacion.objetoContratacionId" name="objetoContratacionId">
                        <mat-option [value]="undefined">No especificar</mat-option>
                        <mat-option *ngFor="let objeto of objetosContratacion" [value]="objeto.id">
                          {{ objeto['codigo'] }} - {{ objeto['nombre'] }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>category</mat-icon>
                    </mat-form-field>
                  </div>

                  <!-- Botones de Acción -->
                  <div class="button-section">
                    <button mat-raised-button
                            color="primary"
                            type="button"
                            (click)="evaluarRequerimiento()"
                            [disabled]="loading || !tieneDatosMinimos">
                      <span *ngIf="loading">
                        <mat-spinner diameter="20"></mat-spinner>
                      </span>
                      <mat-icon *ngIf="!loading">play_arrow</mat-icon>
                      {{ loading ? 'Evaluando...' : 'Evaluar Requerimiento' }}
                    </button>

                    <button mat-button
                            type="button"
                            (click)="generarEjemploAleatorio()"
                            [disabled]="loading">
                      <mat-icon>shuffle</mat-icon>
                      Ejemplo Aleatorio
                    </button>

                    <button mat-button
                            color="accent"
                            type="button"
                            (click)="limpiarFormulario()"
                            [disabled]="loading">
                      <mat-icon>refresh</mat-icon>
                      Limpiar
                    </button>
                  </div>
                </form>
              </mat-card-content>
            </mat-card>

            <!-- Paramétricas Vigentes -->
            <div class="parametricas-section">
              <mat-card class="parametricas-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>timeline</mat-icon>
                    Paramétricas Vigentes
                    <span *ngIf="evaluacion.anioVigencia" class="anio-badge">
                      {{ evaluacion.anioVigencia }}
                    </span>
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div *ngIf="loadingParametricas" class="loading-parametricas">
                    <mat-spinner diameter="30"></mat-spinner>
                    <p>Cargando paramétricas vigentes...</p>
                  </div>

                  <div *ngIf="!loadingParametricas && tieneParametricasVigentes" class="parametricas-info">
                    <!-- UIT Vigente -->
                    <div class="parametrica-item uit-item">
                      <mat-icon class="parametrica-icon primary">monetization_on</mat-icon>
                      <div class="parametrica-details">
                        <h4>{{ obtenerDescripcionUIT() }}</h4>
                        <p>Unidad Impositiva Tributaria vigente</p>
                      </div>
                    </div>

                    <!-- Estadísticas -->
                    <div class="parametricas-stats">
                      <div class="stat-item">
                        <span class="stat-number">{{ cantidadTiposProceso }}</span>
                        <span class="stat-label">Tipos de Proceso</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-number">{{ cantidadObjetosContratacion }}</span>
                        <span class="stat-label">Objetos</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-number">{{ cantidadTopesVigentes }}</span>
                        <span class="stat-label">Topes Vigentes</span>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="!loadingParametricas && !tieneParametricasVigentes" class="no-parametricas">
                    <mat-icon class="empty-icon">info</mat-icon>
                    <h3>Selecciona una fecha</h3>
                    <p>Las paramétricas vigentes se cargarán según la fecha del requerimiento</p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Tab de Resultados -->
      <mat-tab label="Resultados" [disabled]="!tieneResultado">
  <div class="tab-content">
    <div *ngIf="tieneResultado" class="resultados-section">

      <!-- Resultado Principal -->
      <mat-card class="resultado-principal-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon [class]="(ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.evaluacionExitosa) ? 'success-icon' : 'error-icon'">
              {{ (ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.evaluacionExitosa) ? 'check_circle' : 'error' }}
            </mat-icon>
            Resultado de la Evaluación
          </mat-card-title>
          <mat-card-subtitle>
            {{ (ultimoResultado && typeof ultimoResultado !== 'string') ? ultimoResultado.mensaje : 'Sin resultado' }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>

          <!-- Recomendación Principal -->
          <div *ngIf="ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.resultadosDetalle?.['tipoProcesoRecomendado']"
               class="recomendacion-principal">
            <div class="recomendacion-header">
              <mat-icon [class]="obtenerColorTipoProceso(ultimoResultado.resultadosDetalle['tipoProcesoRecomendado'])">
                {{ obtenerIconoTipoProceso(ultimoResultado.resultadosDetalle['tipoProcesoRecomendado']) }}
              </mat-icon>
              <h2>{{ ultimoResultado.resultadosDetalle['tipoProcesoRecomendado'] }}</h2>
            </div>

            <div class="sustento-section">
              <h4>Sustento de la Recomendación:</h4>
              <p class="sustento-text">{{ ultimoResultado.resultadosDetalle['sustento'] }}</p>
            </div>
          </div>

          <!-- Detalles de la Evaluación -->
          <mat-divider></mat-divider>
          <div class="detalles-evaluacion">
            <h4>Detalles de la Evaluación:</h4>

            <div class="detalles-grid">
              <div class="detalle-item">
                <mat-icon>monetization_on</mat-icon>
                <div>
                  <strong>Monto Evaluado:</strong>
                  <span>{{
                    (ultimoResultado && typeof ultimoResultado !== 'string')
                    ? formatearMonto(ultimoResultado?.resultadosDetalle?.['montoEvaluado'] || 0)
                    : 'S/ 0'
                  }}</span>
                </div>
              </div>

              <div class="detalle-item" *ngIf="ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.resultadosDetalle?.['uitUtilizada']">
                <mat-icon>account_balance</mat-icon>
                <div>
                  <strong>UIT Utilizada:</strong>
                  <span>{{ formatearMonto(ultimoResultado.resultadosDetalle['uitUtilizada']) }}</span>
                </div>
              </div>

              <div class="detalle-item">
                <mat-icon>calendar_today</mat-icon>
                <div>
                  <strong>Año de Vigencia:</strong>
                  <span>{{
                    (ultimoResultado && typeof ultimoResultado !== 'string')
                    ? (ultimoResultado?.resultadosDetalle?.['anioVigencia'] || '--')
                    : '--'
                  }}</span>
                </div>
              </div>

              <div class="detalle-item">
                <mat-icon>schedule</mat-icon>
                <div>
                  <strong>Fecha de Evaluación:</strong>
                  <span>{{
                    (ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado?.resultadosDetalle?.['fechaEvaluacion'])
                    ? (ultimoResultado.resultadosDetalle['fechaEvaluacion'] | date:'short')
                    : '--'
                  }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Reglas Aplicadas -->
          <mat-divider></mat-divider>
          <div class="reglas-aplicadas">
            <h4>
              <mat-icon>rule</mat-icon>
              Reglas Aplicadas ({{
                (ultimoResultado && typeof ultimoResultado !== 'string')
                ? (ultimoResultado.reglasAplicadas?.length || 0)
                : 0
              }})
            </h4>

            <div class="reglas-chips" *ngIf="ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.reglasAplicadas?.length">
              <mat-chip
                *ngFor="let regla of ultimoResultado.reglasAplicadas"
                class="regla-chip">
                <mat-icon>check_circle</mat-icon>
                {{ regla }}
              </mat-chip>
            </div>

            <div *ngIf="!ultimoResultado || typeof ultimoResultado === 'string' || !ultimoResultado.reglasAplicadas?.length" class="no-reglas">
              <mat-icon>warning</mat-icon>
              <p>No se aplicaron reglas específicas</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Paramétricas Utilizadas -->
      <mat-card class="parametricas-utilizadas-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>data_usage</mat-icon>
            Paramétricas Utilizadas
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="parametricas-utilizadas-grid">

            <!-- UIT Utilizada -->
            <div class="parametrica-utilizada" *ngIf="ultimoResultado && typeof ultimoResultado !== 'string' && ultimoResultado.parametricasUtilizadas?.['uitVigente']">
  <h5>
    <mat-icon>monetization_on</mat-icon>
    UIT {{ ultimoResultado.parametricasUtilizadas['uitVigente']?.['anioVigencia'] }}
  </h5>
  <p class="parametrica-valor">
    {{ formatearMonto(ultimoResultado.parametricasUtilizadas['uitVigente']?.['monto']) }}
  </p>
  <small>{{ ultimoResultado.parametricasUtilizadas['uitVigente']?.['observaciones'] }}</small>
</div>

            <!-- Tipos de Proceso -->
            <div class="parametrica-utilizada">
              <h5>
                <mat-icon>account_tree</mat-icon>
                Tipos de Proceso Vigentes
              </h5>
              <p class="parametrica-valor">
                {{
                  (ultimoResultado && typeof ultimoResultado !== 'string')
                  ? (ultimoResultado.parametricasUtilizadas?.tiposProceso?.length || 0)
                  : 0
                }} tipos disponibles
              </p>
            </div>

            <!-- Topes Vigentes -->
            <div class="parametrica-utilizada">
              <h5>
                <mat-icon>policy</mat-icon>
                Topes Vigentes
              </h5>
              <p class="parametrica-valor">
                {{
                  (ultimoResultado && typeof ultimoResultado !== 'string')
                  ? (ultimoResultado.parametricasUtilizadas?.topesVigentes?.length || 0)
                  : 0
                }} topes aplicables
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Estado sin resultados -->
    <div *ngIf="!tieneResultado" class="sin-resultados">
      <mat-icon class="empty-icon">analytics</mat-icon>
      <h3>No hay resultados aún</h3>
      <p>Ejecuta una evaluación en la pestaña anterior para ver los resultados aquí</p>
    </div>
  </div>
</mat-tab>
    </mat-tab-group>
  </div>
</div>
